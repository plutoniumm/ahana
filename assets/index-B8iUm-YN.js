(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}})();const f={add:(e,t)=>({x:e.x+t.x,y:e.y+t.y}),sub:(e,t)=>({x:e.x-t.x,y:e.y-t.y}),dot:(e,t)=>e.x*t.x+e.y*t.y,mag:e=>Math.sqrt(e.x*e.x+e.y*e.y),normalize:e=>{const t=Math.sqrt(e.x*e.x+e.y*e.y);return t===0?{x:0,y:0}:{x:e.x/t,y:e.y/t}},rotate:(e,t)=>({x:e.x*Math.cos(t)-e.y*Math.sin(t),y:e.x*Math.sin(t)+e.y*Math.cos(t)}),cross:(e,t)=>e.x*t.y-e.y*t.x,dist:(e,t)=>Math.hypot(e.x-t.x,e.y-t.y)};class K{constructor(t,n){this.x=t,this.y=n,this.rotation=0,this.refractiveIndex=1.5,this.selected=!1}toLocal(t){let n=t.x-this.x,o=t.y-this.y;return{x:n*Math.cos(-this.rotation)-o*Math.sin(-this.rotation),y:n*Math.sin(-this.rotation)+o*Math.cos(-this.rotation)}}toWorld(t){let n=t.x*Math.cos(this.rotation)-t.y*Math.sin(this.rotation),o=t.x*Math.sin(this.rotation)+t.y*Math.cos(this.rotation);return{x:n+this.x,y:o+this.y}}dirToWorld(t){return{x:t.x*Math.cos(this.rotation)-t.y*Math.sin(this.rotation),y:t.x*Math.sin(this.rotation)+t.y*Math.cos(this.rotation)}}}class j extends K{constructor(t,n,o){super(t,n),this.relVertices=o}getWorldVertices(){return this.relVertices.map(t=>this.toWorld(t))}intersect(t,n){const o=this.getWorldVertices();let s=null,i=1/0;for(let l=0;l<o.length;l++){const c=o[l],p=o[(l+1)%o.length],g=f.sub(p,c),h=f.sub(t,c),P=f.sub(p,c),d={x:-n.y,y:n.x},x=f.dot(P,d);if(Math.abs(x)<1e-6)continue;const y=f.cross(P,h)/x,E=f.dot(h,d)/x;if(y>=.001&&E>=0&&E<=1&&y<i){i=y;let T=f.normalize(g),S={x:-T.y,y:T.x};s={t:y,point:f.add(t,{x:n.x*y,y:n.y*y}),normal:S,obj:this}}}return s}draw(t){const n=this.getWorldVertices();t.beginPath(),t.moveTo(n[0].x,n[0].y);for(let o=1;o<n.length;o++)t.lineTo(n[o].x,n[o].y);t.closePath(),t.fillStyle=this.selected?"rgba(255, 0, 222, 0.2)":"rgba(200, 230, 255, 0.15)",t.strokeStyle=this.selected?"#ff00de":"#00d2ff",t.lineWidth=2,t.fill(),t.stroke()}hitTest(t,n){const o=this.getWorldVertices();let s=!1;for(let i=0,l=o.length-1;i<o.length;l=i++){const c=o[i].x,p=o[i].y,g=o[l].x,h=o[l].y;p>n!=h>n&&t<(g-c)*(n-p)/(h-p)+c&&(s=!s)}return s}}class W extends K{constructor(t,n,o){super(t,n),this.type=o,this.height=120,this.width=20,this.curvature=.008}intersect(t,n){const o=this.toLocal(t),s={x:n.x*Math.cos(-this.rotation)-n.y*Math.sin(-this.rotation),y:n.x*Math.sin(-this.rotation)+n.y*Math.cos(-this.rotation)};let i=[];const l=1/Math.max(.001,this.curvature);let c=l-this.width/2;this.type==="diverging"&&(c=l+this.width/4);const p=[{x:-c,y:0,sign:1},{x:c,y:0,sign:1}];return this.type==="diverging"&&(p[0].sign=-1,p[1].sign=-1),p.forEach(g=>{const h=f.sub(o,g),P=1,d=2*f.dot(s,h),x=f.dot(h,h)-l*l,y=d*d-4*P*x;if(y>=0){const E=Math.sqrt(y),T=(-d-E)/2,S=(-d+E)/2;[T,S].forEach(F=>{if(F>.001){const V=f.add(o,{x:s.x*F,y:s.y*F});if(Math.abs(V.y)<this.height/2){let q=!1;if(this.type==="converging"?Math.abs(V.x)<this.width&&(q=!0):Math.abs(V.x)<this.width&&(q=!0),q){let C=f.normalize(f.sub(V,g));g.sign<0&&(C={x:-C.x,y:-C.y}),i.push({t:F,point:this.toWorld(V),normal:this.dirToWorld(C),obj:this})}}}})}}),i.length===0?null:(i.sort((g,h)=>g.t-h.t),i[0])}draw(t){t.save(),t.translate(this.x,this.y),t.rotate(this.rotation),t.fillStyle=this.selected?"rgba(255, 0, 222, 0.2)":"rgba(200, 230, 255, 0.15)",t.strokeStyle=this.selected?"#ff00de":"#00d2ff",t.lineWidth=2;const n=1/Math.max(.001,this.curvature),o=Math.asin(this.height/2/n);if(t.beginPath(),this.type==="converging"){const s=n-this.width/2;t.arc(s,0,n,Math.PI-o,Math.PI+o),t.arc(-s,0,n,-o,o)}else{const s=n+this.width/4;t.arc(-s,0,n,-o,o,!0),t.arc(s,0,n,Math.PI-o,Math.PI+o,!0)}t.closePath(),t.fill(),t.stroke(),t.restore()}hitTest(t,n){const o=this.toLocal({x:t,y:n});return Math.abs(o.x)<20&&Math.abs(o.y)<this.height/2}}const L=document.getElementById("simCanvas"),a=L.getContext("2d",{alpha:!1});let w,b,I={x:0,y:0},v=1;const nt=.2,ot=5;let H=!1,N={x:0,y:0},X={x:0,y:0};const G=.04,st=12;let m={x:100,y:300},M=[],u=null,O=null,Y={x:0,y:0};const r={selection:document.getElementById("selectionPanel"),rot:document.getElementById("objRotation"),rotVal:document.getElementById("objRotVal"),ior:document.getElementById("objIOR"),iorVal:document.getElementById("objIORVal"),curve:document.getElementById("objCurve"),lensCtrl:document.getElementById("lensControls"),spread:document.getElementById("spreadSlider"),spreadVal:document.getElementById("spreadVal"),angle:document.getElementById("angleSlider"),angleVal:document.getElementById("angleVal"),rays:document.getElementById("rayCountSlider"),raysVal:document.getElementById("rayVal")};let k=null,Z=!1,z={x:0,y:0},A={x:0,y:0};function it(e){const t=e.target.closest(".panel");if(!t||e.target instanceof HTMLElement&&e.target.tagName.toLowerCase()==="input"||e.target instanceof HTMLElement&&e.target.tagName.toLowerCase()==="button")return;k=t,Z=!0,document.body.style.cursor="move",z={x:e.clientX,y:e.clientY};const n=t.getBoundingClientRect();A={x:n.left,y:n.top},e.preventDefault()}document.addEventListener("mousedown",e=>it(e));window.addEventListener("mousemove",e=>{if(!Z||!k)return;const t=e.clientX-z.x,n=e.clientY-z.y;k.style.left=A.x+t+"px",k.style.top=A.y+n+"px"});window.addEventListener("mouseup",()=>{Z=!1,k=null,document.body.style.cursor=""});function J(){window.addEventListener("resize",U),U(),Q(),r.angle.value="0",L.addEventListener("mousedown",dt),L.addEventListener("mousemove",ht),L.addEventListener("mouseup",ut),L.addEventListener("wheel",n=>{n.preventDefault();const o=n.clientX,s=n.clientY,i=D(o,s),l=n.deltaY,c=Math.exp(-l*.0015);v=Math.min(ot,Math.max(nt,v*c)),I.x=o-i.x*v,I.y=s-i.y*v},{passive:!1}),r.rot.oninput=B,r.ior.oninput=B,r.curve.oninput=B,r.spread.oninput=()=>r.spreadVal.innerText=r.spread.value+"째",r.angle.oninput=()=>r.angleVal.innerText=r.angle.value+"째",r.rays.oninput=()=>r.raysVal.innerText=r.rays.value,r.rot.oninput=n=>{B(),r.rotVal.innerText=n.target.value+"째"},r.ior.oninput=n=>{B(),r.iorVal.innerText=parseFloat(n.target.value).toFixed(2)};const e=document.getElementById("btnReconvergence"),t=document.getElementById("btnPinkFloyd");e&&e.addEventListener("click",tt),t&&t.addEventListener("click",et),requestAnimationFrame($)}J();window.addPrism=Q;window.addBlock=rt;window.addLens=at;window.clearScene=_;window.deleteSelected=lt;window.runPinkFloyd=et;window.runReconvergence=tt;function U(){w=L.width=window.innerWidth,b=L.height=window.innerHeight}function Q(){const t=100*Math.sqrt(3)/2,n=[{x:-100/2,y:t/3},{x:100/2,y:t/3},{x:0,y:-2*t/3}];M.push(new j(w/2,b/2,n))}function rt(){const n=[{x:-60,y:-40},{x:60,y:-40},{x:60,y:40},{x:-60,y:40}];M.push(new j(w/2,b/2,n))}function at(e){M.push(new W(w/2,b/2,e))}function _(){M=[],u=null,r.selection.style.display="none"}function lt(){u&&(M=M.filter(e=>e!==u),u=null,r.selection.style.display="none")}function B(){u&&(u.rotation=parseFloat(r.rot.value)*(Math.PI/180),u.refractiveIndex=parseFloat(r.ior.value),u instanceof W&&(u.curvature=parseFloat(r.curve.value)))}function $(){a.fillStyle="#080808",a.fillRect(0,0,w,b),a.save(),a.translate(I.x,I.y),a.scale(v,v),a.strokeStyle="#1a1a1a",a.lineWidth=1/v;const e=50,t=-I.x/v,n=-I.y/v,o=t+w/v,s=n+b/v;let i=Math.floor(t/e)*e,l=Math.floor(n/e)*e;for(let d=i;d<=o;d+=e)a.beginPath(),a.moveTo(d,n),a.lineTo(d,s),a.stroke();for(let d=l;d<=s;d+=e)a.beginPath(),a.moveTo(t,d),a.lineTo(o,d),a.stroke();M.forEach(d=>d.draw(a)),a.globalCompositeOperation="screen";const c=parseInt(r.rays.value),g=parseInt(r.spread.value)*(Math.PI/180),h=parseFloat(r.angle.value)*(Math.PI/180);[{color:"#ff0000",nOffset:-G,label:"R"},{color:"#00ff00",nOffset:0,label:"G"},{color:"#0088ff",nOffset:G,label:"B"}].forEach(d=>{a.strokeStyle=d.color,a.beginPath();for(let x=0;x<c;x++){let y=h;if(g>0&&c>1){const E=x/(c-1);y+=(E-.5)*g*2}ct({x:m.x,y:m.y},{x:Math.cos(y),y:Math.sin(y)},d.nOffset)}a.stroke()}),a.globalCompositeOperation="source-over",a.fillStyle="#fff",a.beginPath(),a.arc(m.x,m.y,6,0,Math.PI*2),a.fill(),a.strokeStyle="#fff",a.beginPath(),a.moveTo(m.x,m.y),a.lineTo(m.x+Math.cos(h)*20,m.y+Math.sin(h)*20),a.stroke(),a.restore(),requestAnimationFrame($)}function ct(e,t,n,o){let s={origin:{...e},dir:{...t}},i=[s.origin];for(let l=0;l<st;l++){let c=null,p=3e3;for(let g of M){const h=g.intersect(s.origin,s.dir);h&&h.t<p&&h.t>.01&&(p=h.t,c=h)}if(c){i.push(c.point);const g=c.obj.refractiveIndex+n,h=f.dot(s.dir,c.normal);let P,d,x;h<0?(P=1,d=g,x=c.normal):(P=g,d=1,x={x:-c.normal.x,y:-c.normal.y});const y=P/d,E=-f.dot(s.dir,x),T=1-y*y*(1-E*E);if(T<0){const S=2*f.dot(s.dir,x);s.dir=f.sub(s.dir,{x:x.x*S,y:x.y*S})}else{const S=y*E-Math.sqrt(T);s.dir={x:y*s.dir.x+S*x.x,y:y*s.dir.y+S*x.y}}s.origin=c.point}else{i.push({x:s.origin.x+s.dir.x*2e3,y:s.origin.y+s.dir.y*2e3});break}}a.moveTo(i[0].x,i[0].y);for(let l=1;l<i.length;l++)a.lineTo(i[l].x,i[l].y)}function D(e,t){return{x:(e-I.x)/v,y:(t-I.y)/v}}function dt(e){const t=e.clientX,n=e.clientY,o=D(t,n);if(f.dist(o,m)<15){O=m;return}let s=null;for(let i=M.length-1;i>=0;i--)if(M[i].hitTest(o.x,o.y)){s=M[i];break}u&&(u.selected=!1),u=s,u?(u.selected=!0,O=u,Y={x:o.x-u.x,y:o.y-u.y},r.selection.style.display="block",r.rot.value=(u.rotation*180/Math.PI).toFixed(0),r.rotVal.innerText=r.rot.value+"째",r.ior.value=String(u.refractiveIndex),r.iorVal.innerText=u.refractiveIndex.toFixed(2),u instanceof W?(r.lensCtrl.style.display="block",r.curve.value=String(u.curvature)):r.lensCtrl.style.display="none"):(H=!0,N={x:t,y:n},X={...I},r.selection.style.display="none")}function ht(e){const t=e.clientX,n=e.clientY;if(H){I.x=X.x+(t-N.x),I.y=X.y+(n-N.y);return}if(!O)return;const o=D(t,n);O===m?(m.x=o.x,m.y=o.y):(O.x=o.x-Y.x,O.y=o.y-Y.y)}function ut(){O=null,H=!1}const R=e=>e*(Math.PI/180);function tt(){_(),r.angle.value="-45",r.angle.dispatchEvent(new Event("input")),r.spread.value="0",r.spread.dispatchEvent(new Event("input")),r.rays.value="10",r.rays.dispatchEvent(new Event("input")),m={x:w*.3,y:b*.75};const e=100,t=e*Math.sqrt(3)/2,n=[{x:-e/2,y:t/3},{x:e/2,y:t/3},{x:0,y:-2*t/3}],o=new j(w*.35,b*.7,n);o.rotation=R(-30);const s=new j(w*.65,b*.66,n);s.rotation=R(30);const i=new W(w*.5,b*.64,"converging");i.curvature=.01,i.refractiveIndex=1.5,i.rotation=R(0),M.push(o,s,i)}function et(){_(),r.angle.value="-15",r.angle.dispatchEvent(new Event("input")),r.spread.value="1",r.spread.dispatchEvent(new Event("input")),r.rays.value="5",r.rays.dispatchEvent(new Event("input")),m={x:w*.4,y:b*.6};const e=120,t=e*Math.sqrt(3)/2,n=[{x:-e/2,y:t/3},{x:e/2,y:t/3},{x:0,y:-2*t/3}],o=new j(w*.55,b*.55,n);o.rotation=R(0),o.refractiveIndex=1.5,M.push(o)}J();
